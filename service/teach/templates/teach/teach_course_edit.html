{% extends 'teach/teach_base.html' %}

{% load static teach_tags %}

{% block teach_layout %}
    <div class="col-md-9">
        <div class="catalog-main-content">
            <div class="col-md-9">
                <form method="post" action="{% url 'teach:course-detail' course.id %}" id="course_update"
                      enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="row mb-50">
                        <div class="col-md-6">
                            <div id="image-box"
                                 class="upload-box {% if not course.preview %}upload-box-border {% endif %}mb-3">
                                {% if course.preview %}
                                    <img id="imagePreview" src="{{ course.preview.url }}" alt="{{ course.course_name }}"
                                         class="preview-img img-fluid rounded ">
                                {% else %}
                                    <div class="text-center">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø—Ä–µ–≤'—é –∫—É—Ä—Å–∞</div>
                                    <img id="imagePreview" src="" alt="imagePreview" class="d-none">
                                {% endif %}
                                <span class="upload-image-placeholder d-block"></span>
                            </div>
                        <div class="mb-20">
                            <input type="file" id="id_preview" class="form-control " name="preview" accept="image/*">
                            </div>
                            <div class="error-container" id="error_preview"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="video-box"
                                 class="upload-box {% if not course.info.preview_video %}upload-box-border {% endif %}mb-3">
                                {% if not course.info.preview_video %}
                                    <span class="upload-video-placeholder d-block">üé•</span>
                                {% else %}
                                    <iframe id="youtubePlayer" width="100%" height="315"
                                            src="https://www.youtube.com/embed/{% get_youtube_thumbnail_url course.info.preview_video %}"
                                            frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowfullscreen></iframe>
                                {% endif %}
                            </div>
                            <input class="form-control" type="text" id="id_preview_video" name="preview_video"
                                   value="{{ course.info.preview_video }}" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube">
                        </div>

                    </div>

                    <div class="row mb-30">
                        <div class="col-md-12">
                            <label for="id_course_name">–ù–∞–∑–≤–∞ –∫—É—Ä—Å—É:</label>
                            <input type="text" class="form-control" name="course_name" maxlength="255"
                                   id="id_course_name" value="{{ course.course_name }}">
                            <div class="error-container" id="error_course_name"></div>  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ -->
                        </div>
                    </div>

                    <div class="row mb-30">
                        <div class="col-md-12">
                            <label for="id_description">–û–ø–∏—Å</label>
                            <textarea name="description" id="id_description" cols="30" rows="10"
                                      class="form-control">{{ course.description }}</textarea>
                            <div class="error-container" id="error_description"></div>  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ -->
                        </div>
                    </div>

                    <div class="row mb-30">
                        <div class="col-md-12 ">
                            <div class="row align-items-baseline">
                                <div class="col-md-3 me-3">
                                    <label for="id_language">–ú–æ–≤–∞</label>
                                    <select class="nice-select" name="language" tabindex="0">
                                        {% for key, value in course.LANG_CHOICES %}
                                            <option value="{{ key }}"
                                                    class="option"
                                                    {% if key == course.language %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="error-container" id="error_language"></div><!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ -->
                                </div>
                                <div class="col-md-3 me-3">
                                    <label for="id_difficulty">–†—ñ–≤–µ–Ω—å</label>
                                    <select class="nice-select" name="difficulty" tabindex="0">
                                        {% for key, value in course.DIFFICULTY_CHOICES %}
                                            <option value="{{ key }}"
                                                    class="option"
                                                    {% if key == course.difficulty %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="error-container" id="error_difficulty"></div>
                                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ -->
                                </div>
                                <div class="col-md-3 me-3">
                                    <label for="id_workload">–ß–∞—Å–∏ —É –Ω–µ–¥—ñ–ª—é</label>
                                    <input type="text" class="form-control" name="workload" maxlength="255"
                                           id="id_workload" value="{{ course.info.workload }}" style="height: 42px;">
                                    <div class="error-container" id="error_workload"></div><!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-30">
                        <div class="row">
                            <h3>–ê–≤—Ç–æ—Ä–∏</h3>
                            <p class="text-secondary">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquam
                                animi
                                aut
                                harum impedit incidunt
                                inventore magni numquam omnis quidem totam! Accusantium commodi corporis dignissimos
                                facilis
                                illum
                                laborum molestias suscipit, voluptate.</p>
                        </div>
                        <div class="row col-md-6">
                            <div id="authors-container" class="mt-3">
                                {% for author in course.info.authors.all %}
                                    <div class="d-flex flex-column">
                                        <div class="row">
                                            <h5>{{ author.first_name }} {{ author.last_name }}</h5>
                                        </div>
                                        <div class="row">
                                            <div class="col-11">
                                                <p>Email: {{ author.email }}</p>
                                            </div>
                                            <div class="col-1">
                                                <a data-author-id="{{ author.id }}">‚úï</a>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="d-flex justify-content-between">
                                <input type="text" class="form-control search-input me-3" name="authors"
                                       id="id_authors">
                                <div class="error-container" id="error_authors"></div>  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫ -->
                                <button class="button-3" name="add_author" id="id_add_author" type="button">–î–æ–¥–∞—Ç–∏
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="course-editor-menu">
                        <div class="course-editor-menu-inner">
                            <button type="submit" class="button-3" id="save-button" style="background-color:#38a73a;">
                                –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>


    <script src="{% static 'assets/js/vendor/jquery-1.12.4.min.js' %}"></script>
    <script>
        $(document).ready(function () {
            $('#course_update').submit(function (event) {
                event.preventDefault(); // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
                $('.error-container').empty();
                var formData = new FormData(this); // —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç FormData

                $.ajax({
                    url: "{% url 'teach:course-detail' course.id %}", // URL –¥–ª—è API
                    type: "PUT", // –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ "POST" –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
                    data: formData,
                    processData: false, // –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    contentType: false, // –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    success: function (response) {
                        $('#jq-notification').text('–ö—É—Ä—Å –æ–Ω–æ–≤–ª–µ–Ω–æ').removeClass('d-none'); // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        $('#jq-notification').fadeIn().delay(3000).fadeOut(); // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã
                        console.log('succsess');
                    },
                    error: function (xhr) {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                        if (xhr.status === 400) {
                            var errors = xhr.responseJSON;
                            console.log(errors);

                            // –û—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
                            $('.error-container').empty();

                            $.each(errors, function (field, messages) {
                                var errorContainer = $('#error_' + field);  // –ù–∞–π—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—à–∏–±–æ–∫
                                if (errorContainer.length) {
                                    errorContainer.append('<div class="form-error-1 text-danger">' + messages.join(', ') + '</div>');
                                }
                            });
                        }
                    }
                });
            });


            function updateAuthors(url, author, succses_text) {
                $.ajax({
                    url: url, // URL –¥–ª—è API
                    type: "PUT", // –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ "POST" –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
                    data: {authors: author},
                    success: function (response) {
                        var authorsContainer = $('#authors-container');
                        authorsContainer.empty(); // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

                        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–º—É –∞–≤—Ç–æ—Ä—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        $.each(response.authors, function (index, author) {
                            var authorHtml = `
                             <div class="d-flex flex-column">
                                        <div class="row">
                                            <h5>${author.first_name} ${author.last_name}</h5>
                                        </div>
                                        <div class="row">

                                            <div class="col-11">
                                                <p>Email: ${author.email}</p>
                                            </div>
                                            <div class="col-1">
                                                <a data-author-id=${author.id}>‚úï
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                        `;
                            authorsContainer.append(authorHtml); // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∞–≤—Ç–æ—Ä–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        });
                        $('#jq-notification').text(succses_text).removeClass('d-none'); // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        $('#jq-notification').fadeIn().delay(3000).fadeOut(); // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã
                    },
                    error: function (xhr) {

                        if (xhr.status === 400) {
                            var errors = xhr.responseJSON;
                            $('.error-container').empty();

                            $.each(errors, function (field, messages) {
                                var errorContainer = $('#error_' + field);
                                if (errorContainer.length) {
                                    errorContainer.append('<div class="form-error-1 text-danger">' + messages.join(', ') + '</div>');
                                }
                            });
                        }
                    }
                });
            }


            document.getElementById('id_add_author').onclick = function () {
                $('.error-container').empty();
                var author = document.getElementById("id_authors").value;
                var url = "{% url 'teach:course-update-authors' course.id %}";
                updateAuthors(url, author, '–ê–≤—Ç–æ—Ä–∞ –¥–æ–¥–∞–Ω–æ');
            };

            $(document).on('click', 'a[data-author-id]', function () {
                var author = $(this).data('author-id');
                var url = "{% url 'teach:course-delete-authors' course.id %}";
                updateAuthors(url, author, '–ê–≤—Ç–æ—Ä–∞ –≤–∏–¥–∞–ª–µ–Ω–æ');


            });
            document.getElementById('id_preview').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('imagePreview').src = e.target.result;
                        document.getElementById('imagePreview').classList.remove('d-none');
                        document.getElementById('imagePreview').classList.add('img-fluid');
                        document.querySelector('.upload-image-placeholder').classList.add('d-none');
                    };
                    reader.readAsDataURL(file);
                }
            });

            function getYouTubeVideoId(url) {
                var pattern = /(?:v=|\/)([0-9A-Za-z_-]{11}).*/;
                var match = url.match(pattern);
                return match ? match[1] : null;
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –ø–ª–µ–µ—Ä–∞ YouTube
            function updateYouTubePlayer(videoUrl) {
                var videoId = getYouTubeVideoId(videoUrl);
                if (videoId) {
                    var embedUrl = "https://www.youtube.com/embed/" + videoId;
                    var iframeHtml = '<iframe id="youtubePlayer" width="100%" height="315" src="' + embedUrl +
                        '" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
                    $('#video-box').html(iframeHtml);  // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–ª–µ–µ—Ä
                } else {
                    $('#video-box').html('<span class="upload-video-placeholder d-block">üé•</span>'); // –ï—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞—è —Å—Å—ã–ª–∫–∞
                }
            }

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–ª–µ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –≤–∏–¥–µ–æ
            $('#id_preview_video').on('input', function () {
                var videoUrl = $(this).val();
                updateYouTubePlayer(videoUrl);
            });


        });
    </script>

{% endblock %}
